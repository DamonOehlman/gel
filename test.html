<!DOCTYPE html>
<html>
<head>
    <title>expression tester</title>
    <script>
        window.gaffa =  {

            model : {
                array : [1, 2, 3],
                prop : 15,
                prop2 : 10,
                empty: {},
                get: function (path) {
                    // slice of []
                    path = path.slice(1,-1);
                    var index = path.indexOf("model/");
                    if (index >= 0) {
                        path = path.substring(index + 6);
                    }
                    return this[path];
                }
            }
        };
    </script>
    <script src="gel.js" type="text/javascript"></script>                
    <script src="jquery.min.js"></script>
    
    <script>
        window.tests = [    
            [
                "1",
                1
            ],
            [
                "-2",
                -2
            ],
            [
                "2.4e9",
                2400000000
            ],
            [
                "1.0E-3",
                0.001
            ],
            [
                "\"a\"",
                "a"
            ],
            [
                "'a'",
                "a"
            ],
            [
                "'\"a\"'",
                "\"a\""
            ],
            [
                "'''",
                "[[ERROR]]"
            ],
            [
                "'\\''",
                "'"
            ],
            [
                "\"\\\"\\\"\"",
                "\"\""
            ],
            [
                "\"\\\"Hello\\\" \\\"World\\\"\"",
                "\"Hello\" \"World\""
            ],
            [
                "'\"Hello\" \"World\"'",
                "\"Hello\" \"World\""
            ],
            [
                "true",
                true
            ],
            [
                "false",
                false
            ],
            [
                "null",
                null
            ],
            [
                "undefined"
            ],
            [
                "(|| trueStartingIdentifier 2)",
                "2"
            ],
            [
                "(= 1 1)",
                true
            ],
            [
                "(= 1 2)",
                false
            ],
            [
                "(! false)",
                true
            ],
            [
                "(= true true)",
                true
            ],
            [
                "(= true (! false))",
                true
            ],
            [
                "(|| 2 0 3)",
                2
            ],
            [
                "(|| 0 0 0)",
                0
            ],
            [
                "(|| false 'If this test passes, lazy evaluation has been implemented' (throwError))",
                'If this test passes, lazy evaluation has been implemented'
            ],
            [
                "(| 2 0 3 false true)",
                true
            ],
            [
                "(| 2 0 3 false false)",
                false
            ],
            [
                "(&& 1 2)",
                2
            ],
            [
                "(+ 0 2)",
                2
            ],
            [
                "(+ 1 2 3 -4)",
                3
            ],
            [
                "(- 1 2)",
                -1
            ],
            [
                "(- 1 2 8)",
                -1
            ],
            [
                "(/ 4 2)",
                2
            ],
            [
                "(/ 0 2)",
                0
            ],
            [
                "(== (/ 2 0) Infinity)",
                true
            ],
            [
                "(== (/ -2 0) -Infinity)",
                true
            ],
             [
                "(== (/ 0 0) NaN)",
                false
            ],
            [
                "(isNaN NaN (/ 0 0) NaN)",
                true
            ],
            [
                "(isNaN NaN Infinity NaN)",
                false
            ],
            [
                "(isNaN)",
                true
            ],
            [
                "(isNaN \"dog\")",
                true
            ],
            [
                "(isNaN \"13\")",
                false
            ],
            [
                "(== (/ 64 8) (/ 4 3))",
                false
            ],
            [
                "(= null undefined)",
                true
            ],
            [
                "(== null undefined)",
                false
            ],
            [
                "(== true (! false))",
                true
            ],
            [
                "(!= true false)",
                true
            ],
            [
                "(!== true (! false))",
                false
            ],
            [
                "(!= true 1)",
                false
            ],
            [
                "(!== true 1)",
                true
            ],
            [
                "(> 1 1)",
                false
            ],
            [
                "(> 2 1)",
                true
            ],
            [
                "(> 1 2)",
                false
            ],
            [
                "(> 3 2)",
                true
            ],
            [
                "(> 1 2)",
                false
            ],
            [
                "(< 1 1)",
                false
            ],
            [
                "(< 2 1)",
                false
            ],
            [
                "(< 1 2)",
                true
            ],
            [
                "(< 3 2)",
                false
            ],
            [
                "(< 1 2)",
                true
            ],
            [
                "(? true 1 2)",
                1
            ],
            [
                "(? false 1 2)",
                2
            ],
            [
                "(? '' 1 2)",
                2
            ],
            [
                "(? 'majigger' 1 2)",
                1
            ],
            [
                "(? true 1)",
                "[[ERROR]]"
            ],
            [
                "(>= 1 2)",
                false
            ],
            [
                "(>= 2 2)",
                true
            ],
            [
                "(>= 2 1)",
                true
            ],
            [
                "(>= 2 3)",
                false
            ],
            [
                "(>= 3 3)",
                true
            ],
            [
                "(<= 2 1)",
                false
            ],
            [
                "(<= 2 2)",
                true
            ],
            [
                "(<= 1 2)",
                true
            ],
            [
                "(<= 2 1)",
                false
            ],
            [
                "(<= 2 2)",
                true
            ],
            [
                "(array 1 2 3 \"abc\")",
                [
                    1,
                    2,
                    3,
                    "abc"
                ]
            ],
            [
                "(concat \"a\" \"b\" \"c\")",
                "abc"
            ],
            [
                "(slice 2 7 \"Hello World\")",
                "llo W"
            ],
            [
                "(slice 1 \"Hello World\")",
                "ello World"
            ],
            [
                "(slice \"Hello World\")",
                "Hello World"
            ],
            [
                "(slice 1 2 (array 1 2 3))",
                [2]
            ],
            [
                "(slice 1 (array 1 2 3))",
                [2, 3]
            ],
            [
                "(slice (array 1 2 3))",
                [1, 2, 3]
            ],
            [
                "(format 'hello {0}' 'world')",
                "hello world"
            ],
            [
                "(filter (array (object 'prop' 5)(object 'prop' 6)(object 'prop' 5)(object 'prop' 'WAT')) {item (= item.prop 5)})",
                [{"prop":5},{"prop":5}]
            ],
            [
                "(contains 'Hello World' 'WAT')",
                false
            ],
            [
                "(contains 'Hello World' 'hello')",
                true
            ],
            [
                "(contains 'Hello World' 'Hello')",
                true
            ],
            [
                "(contains true 'Hello World' 'hello')",
                false
            ],
            [
                "(contains false 'Hello World' 'hello')",
                true
            ],
            [
                "(last (array 1 2 3 \"abc\"))",
                "abc"
            ],
            [
                "(object \"key\" \"value\")",
                {"key": "value"}
            ],
            [
                "(date 123 123 123)",
                "[[ERROR]]"
            ],
            [
                "(date 1355745289462)",
                "2012-12-17T11:54:49.462Z"
            ],
            [
                "(date.addDays (date 1355745289462) 7)",
                "2012-12-24T11:54:49.462Z"
            ],
            [
                "(date.addDays (date 1355745289462) -7)",
                "2012-12-10T11:54:49.462Z"
            ],
            [
                "(max 1 5 3 4 2)",
                5
            ],
            [
                "()",
                '[[ERROR]]'
            ],
            [
                "[model/array]",
                [
                    1,
                    2,
                    3
                ]
            ],
            [
                "(last [model/array])",
                3
            ],
            [
                "(length [model/array])",
                3
            ],
            [
                "(length \"string\")",
                6
            ],
            [
                "(max [model/prop] 10)",
                15
            ],
            [
                "(concat [model/prop] \" good sir\")",
                "[[ERROR]]"
            ],
            [
                "(concat (toString [model/prop]) \" good sir\")",
                "15 good sir"
            ],
            [
                "(! (&& [model/prop] [model/prop2]))",
                false
            ],
            [
                "(/ [model/prop] [model/prop2])",
                1.5
            ],
            [
                "(= 10 [model/prop2])",
                true
            ],
            [
                "(= (object) [model/empty])",
                false
            ],
            [
                "(= [model/prop])",
                "[[ERROR]]"
            ],
            [
                "(= (+ 10 15.5) (concat \"25\" \".5\"))",
                true
            ],
            [
                "(compare (array 1 2 3) (array 1 2 3) =)",
                true
            ],
            [
                "(compare (array 1 5 3) (array 1 5 3) (array 1 5 3) (array 1 5 3) =)",
                true
            ],
            [
                "(compare (array 4 5 6) (array 1 2 3) =)",
                false
            ],
            [
                "(== (+ 10 15.5) (concat \"25\" \".5\"))",
                false
            ],
            [
                "(refine true (object 'stuff' 1 'things' 2 'majigger' 3) 'stuff' 'things')",
                {majigger:3}
            ],
            [
                "(fromJSON '{\"hello\":[\"world\"]}')",
                {"hello":["world"]}
            ],
            [
                "(filter (array (array 1 2 3)(array 1 4 3)(array 2 2 3)){item (< 1 (length(filter item {item (= item 2)})))})",
                [[2,2,3]]
            ],
            [
                "(filter (array (array 1 2 3)(array 1 4 3)(array 2 2 3)){item (= 1 (length(filter item {item (= item 2)})))})",
                [[1,2,3]]
            ],
            [
                "(replace 'c1 c2 c3 c4' 'c2' '')",
                "c1  c3 c4"
            ],
            [
                "(replace 'cool stuff and that' 'stuff' 'stuff stuff')",
                "cool stuff stuff and that"
            ],
            [
                "(object 'thing' 5).thing",
                5
            ],
            [
                "(filter (array 1 2 3 4 5 4 3 2 1)  {item (= item 2)} )",
                [2,2]
            ],
            [
                "(demoFunc)",
                123456
            ],
            [
                "(demoFunc",
                "[[ERROR]]"
            ],
            [
                "(demoFunc}",
                "[[ERROR]]"
            ],
            [
                "demoFunc",
                "function () { return 123456; }"
            ],
            [
                "Zomg wtf is this shit"
            ],
            [
                "\"not a well formed\" string\"",
                "[[ERROR]]"
            ],
            [
                "(map anArray (partial concat 'world '))",
                ["world a","world b","world c"]
            ],
            [
                "(map anArray {string (concat 'world ' string)})",
                ["world a","world b","world c"]
            ],
            [
                "(map anArray (compose length (partial concat 'world ')))",
                [7,7,7]
            ],
            [
                "(map anArray {item (length (concat 'world ' item))})",
                [7,7,7]
            ],
            [
                "(map anArray (compose length (partial (flip concat) 'world ')))",
                [7,7,7]
            ],
            [
                "(map anArray {item (length (concat item 'world '))})",
                [7,7,7]
            ],
            [
                "(fold anOtherArray 0 +)",
                6
            ],
            [
                "(compare (array 1 2 3) (array 2 3 4) <)",
                true
            ],
            [
                "(compare (array 1 2 3) (array 2 3 4) >)",
                false
            ]
        ];
        
    </script>
    
    <script>

        var gel = new window.Gel();
        
        // Add a custom gel function
        gel.functions["demoFunc"] = function() {
            return 123456;
        };
        
        gel.functions["throwError"] = function() {
            throw "error";
        };
        
        // Add a custom token converter
        gel.tokenConverters.other["path"] = {
            tokenise:function(substring){
                if (substring.charAt(0) === '[') {
                    var index = 1;
                        
                    do {
                        if (
                            (substring.charAt(index) === '\\' && substring.charAt(index + 1) === '\\') || // escaped escapes
                            (substring.charAt(index) === '\\' && (substring.charAt(index + 1) === '[' || substring.charAt(index + 1) === ']')) //escaped braces
                        ) {
                            index++;
                        }
                        else if(substring.charAt(index) === ']'){                        
                            var original = substring.slice(0, index+1);
                            
                            return new gel.Token(
                                this,
                                original,
                                original.length
                            );
                        }
                        index++;
                    } while (index < substring.length);
                }
            },
            parse: function(){},
            evaluate: function(){
                this.result = gaffa.model.get(this.original, gaffa.model.get.context, true);
            }
        }
        
        String.prototype.format = String.prototype.format || function () {
            var s = this,
                i = arguments.length;

            while (i--) {
                var v;
                try {
                    v = arguments[i].toString();
                }
                catch (ex) {
                    v = arguments[i];
                }
                s = s.replace(new RegExp('\\{' + i + '\\}', 'gm'), v);
            }
            return s;
        };


        function arrayEqual(arrayX, arrayY) {
            if (!arrayX || !arrayY) {
                return false;    
            }
            
            if (arrayX.length != arrayY.length) return false;

            for (var i = 0; i < arrayX.length; i++) {
                if (arrayX[i] != arrayY[i]) {
                    return false;
                }
            }

            return true;
        }
		
		var context = {
			contextProp:10,
			customFunc: function(item){
				return item < 10;
			},
			console:{
				log: function(){console.log(arguments)}
			},
			anArray: ["a","b","c"],
			anOtherArray: [1,2,3]
		}

        $(document).ready(function () {
            var numPassed = 0,				
                numFailed = 0;
            
            for (var index = 0; index < tests.length; index++) {
                var test = tests[index][0],
                    expected = tests[index][1],
                    a,
                    e;
                    

                var actual = "[[ERROR]]";
                var exceptionMsg = "";
                try {
                    actual = gel.evaluate(test, context);
                }
                catch (ex) {
                    exceptionMsg = ex;
                    console.warn("Scan function failed!" + ex , ex);
                }
                finally { }

                    
                // special case for printed functions
                if (typeof actual === "function"){
                    a =  actual.toString().replace(/\s+/g, '');
                    e = expected.replace(/\s+/g, '');
                    passFail = a === e;
                } else if(typeof actual === "object"){
                    actual = a =  JSON.stringify(actual);
                    expected = e = JSON.stringify(expected);
                    passFail = a === e;
                } else {
                    passFail = actual === expected;
                }
                
                passFail ? numPassed++ : numFailed++;
                
                var trString = 
                    '<tr class="{0}"><td>{1}</td><td>{2}</td><td>{3}</td><td>{4}</td><td>{5}</td></tr>'
                    .format((passFail ? "pass" : "fail"), index, test, actual, expected, exceptionMsg);
                    
                passFail ? $("#initialtests .passedTests").append(trString) : $("#initialtests .failedTests").append(trString);
            }
            
            if(numFailed){
                $("#initialtests").before('<h1 class="fail">FAIL</h1>');
            }else{			
                $("#initialtests").before('<h1 class="pass">SUCCESS</h1>');
            }
            
            $("#initialtests").before('<h2>' + numPassed + ' Passed, ' + numFailed + ' Failed</h2>');
        });
        
        $(document).on('click', 'button.run',function(){
             var expression = $('.expressions').val(),
                resultBox = $('.results').removeClass('fail').text(''),
                result;
			try{
				result = gel.evaluate(expression, context);
			}catch(error){
				resultBox.text(error).addClass('fail');
			}
				
			if(typeof result === 'function'){
				resultBox.text(result.toString());
			}else{
				resultBox.text(JSON.stringify(result));
			}
                                
        });

    </script>
    <style type="text/css">
        textarea {
            width: 90%;
            height:250px;
        }

        td, th {
            padding: 3px;
        }

        .pass {
            background-color:#b6ff00;
        }

        .fail {
            background-color: #ff6b6b;
            
        }
		
		.results{
			font-size:2em;
		}
        
    </style>
</head>
<body>
    <h1>Expression tester</h1>
    <textarea class="expressions"></textarea>
    <br />
    <button class="run">Run</button>   <br />
    <pre class="results"></pre>

    <table id="initialtests">
        <thead>
            <tr>
                <th>Id</th><th>Input</th><th>Actual</th><th>Expected</th><th>Exception</th>
            </tr>
        </thead>
        <tbody class="failedTests">

        </tbody>
        <tbody class="passedTests">

        </tbody>
    </table>
</body>
</html>
